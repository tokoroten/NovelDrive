<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; connect-src 'self'">
    <title>ナレッジグラフビジュアル - NovelDrive</title>
    <link rel="stylesheet" href="./styles/common.css">
    <link rel="stylesheet" href="./styles/knowledge-graph-visual.css">
</head>
<body>
    <div class="app-container">
        <!-- サイドバー -->
        <nav class="sidebar">
            <div class="app-title">
                <h1>NovelDrive</h1>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="./agent-meeting.html" data-page="agent-meeting">
                        <span class="icon">🤝</span>
                        <span>エージェント会議室</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="./projects.html" data-page="projects">
                        <span class="icon">📁</span>
                        <span>プロジェクト</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="./project-workspace.html" data-page="project-workspace">
                        <span class="icon">💼</span>
                        <span>ワークスペース</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="./writing-editor.html" data-page="writing-editor">
                        <span class="icon">✍️</span>
                        <span>執筆エディタ</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="./anything-box.html" data-page="anything-box">
                        <span class="icon">📥</span>
                        <span>なんでもボックス</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="./serendipity.html" data-page="serendipity">
                        <span class="icon">✨</span>
                        <span>セレンディピティ</span>
                    </a>
                </li>
                <li class="nav-item active">
                    <a href="./knowledge-graph-visual.html" data-page="knowledge-graph-visual">
                        <span class="icon">🔗</span>
                        <span>ビジュアルグラフ</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="./settings.html" data-page="settings">
                        <span class="icon">⚙️</span>
                        <span>設定</span>
                    </a>
                </li>
            </ul>
        </nav>

        <!-- メインコンテンツ -->
        <main class="main-content">
            <header class="page-header">
                <div>
                    <h2>ビジュアルナレッジグラフ</h2>
                    <p class="page-description">物語の要素間の関係を視覚的に探索</p>
                </div>
                <div class="header-actions">
                    <select id="project-selector" class="project-selector">
                        <option value="">プロジェクトを選択...</option>
                    </select>
                </div>
            </header>

            <!-- グラフコントロール -->
            <div class="graph-controls">
                <div class="control-section">
                    <h4>表示フィルター</h4>
                    <div class="filter-group">
                        <label class="checkbox-label">
                            <input type="checkbox" class="node-type-filter" value="character" checked>
                            <span class="node-icon character">👤</span>
                            キャラクター
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" class="node-type-filter" value="location" checked>
                            <span class="node-icon location">📍</span>
                            場所
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" class="node-type-filter" value="item" checked>
                            <span class="node-icon item">🎁</span>
                            アイテム
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" class="node-type-filter" value="event" checked>
                            <span class="node-icon event">📅</span>
                            出来事
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" class="node-type-filter" value="world" checked>
                            <span class="node-icon world">🌍</span>
                            世界設定
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" class="node-type-filter" value="other" checked>
                            <span class="node-icon other">📂</span>
                            その他
                        </label>
                    </div>
                </div>

                <div class="control-section">
                    <h4>グラフ設定</h4>
                    <div class="control-group">
                        <label>ノードサイズ</label>
                        <input type="range" id="node-size-slider" min="10" max="50" value="20" class="slider">
                        <span id="node-size-value">20</span>
                    </div>
                    <div class="control-group">
                        <label>リンク距離</label>
                        <input type="range" id="link-distance-slider" min="50" max="300" value="150" class="slider">
                        <span id="link-distance-value">150</span>
                    </div>
                    <div class="control-group">
                        <label>力の強さ</label>
                        <input type="range" id="force-strength-slider" min="-100" max="0" value="-30" class="slider">
                        <span id="force-strength-value">-30</span>
                    </div>
                </div>

                <div class="control-section">
                    <h4>検索</h4>
                    <input type="text" id="node-search" placeholder="ノードを検索..." class="search-input">
                    <div class="search-results" id="search-results" style="display: none;"></div>
                </div>

                <div class="control-section">
                    <h4>アクション</h4>
                    <button class="action-btn" id="reset-zoom">
                        <span class="icon">🔄</span>
                        ズームリセット
                    </button>
                    <button class="action-btn" id="fit-view">
                        <span class="icon">📐</span>
                        全体表示
                    </button>
                    <button class="action-btn" id="export-image">
                        <span class="icon">📸</span>
                        画像保存
                    </button>
                </div>
            </div>

            <!-- グラフビューコンテナ -->
            <div class="graph-view-container">
                <div id="graph-svg-container" class="graph-svg-container">
                    <!-- D3.jsグラフがここに描画されます -->
                </div>

                <!-- ノード詳細パネル -->
                <div id="node-detail-panel" class="node-detail-panel" style="display: none;">
                    <div class="panel-header">
                        <h3 id="node-detail-title">ノード詳細</h3>
                        <button class="close-btn" id="close-detail-panel">✕</button>
                    </div>
                    <div class="panel-content">
                        <div class="detail-section">
                            <label>タイプ</label>
                            <p id="node-detail-type"></p>
                        </div>
                        <div class="detail-section">
                            <label>内容</label>
                            <div id="node-detail-content"></div>
                        </div>
                        <div class="detail-section">
                            <label>タグ</label>
                            <div id="node-detail-tags" class="tag-list"></div>
                        </div>
                        <div class="detail-section">
                            <label>関連ノード</label>
                            <div id="node-detail-relations" class="relation-list"></div>
                        </div>
                        <div class="detail-actions">
                            <button class="primary-btn" id="edit-node-btn">編集</button>
                            <button class="secondary-btn" id="focus-node-btn">フォーカス</button>
                        </div>
                    </div>
                </div>

                <!-- ミニマップ -->
                <div id="minimap" class="minimap">
                    <div class="minimap-header">ミニマップ</div>
                    <div id="minimap-content" class="minimap-content">
                        <!-- ミニマップがここに描画されます -->
                    </div>
                </div>

                <!-- グラフ統計 -->
                <div id="graph-stats" class="graph-stats">
                    <div class="stat-item">
                        <label>ノード数</label>
                        <span id="node-count">0</span>
                    </div>
                    <div class="stat-item">
                        <label>リンク数</label>
                        <span id="link-count">0</span>
                    </div>
                    <div class="stat-item">
                        <label>クラスター数</label>
                        <span id="cluster-count">0</span>
                    </div>
                </div>
            </div>

            <!-- 空の状態 -->
            <div id="empty-state" class="empty-state" style="display: none;">
                <div class="empty-icon">🔗</div>
                <h3>知識グラフを構築しましょう</h3>
                <p>プロジェクトに知識を追加すると、ここに関係性が表示されます</p>
                <a href="./project-knowledge.html" class="primary-btn">知識を追加</a>
            </div>
        </main>
    </div>

    <!-- ツールチップ -->
    <div id="tooltip" class="tooltip" style="display: none;"></div>

    <!-- コンテキストメニュー -->
    <div id="context-menu" class="context-menu" style="display: none;">
        <ul>
            <li id="view-details">詳細を表示</li>
            <li id="edit-node">編集</li>
            <li id="hide-node">非表示</li>
            <li class="separator"></li>
            <li id="expand-relations">関連を展開</li>
            <li id="collapse-relations">関連を折りたたむ</li>
        </ul>
    </div>

    <script>
        // Check if Mock API is available for browser testing
        if (typeof window !== 'undefined' && !window.api) {
            console.log('Loading Mock API for browser testing');
        }
    </script>
    <script src="./js/mock-api.js"></script>
    <script src="./js/project-selector.js"></script>
    <script src="./js/knowledge-graph-visual.js"></script>
</body>
</html>