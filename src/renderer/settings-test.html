<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings Functionality Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        input[type="text"] {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        pre {
            background: #f8f8f8;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>NovelDrive Settings Functionality Test</h1>
    
    <div class="test-section">
        <h2>Environment Check</h2>
        <div id="env-results"></div>
    </div>
    
    <div class="test-section">
        <h2>API Key Test</h2>
        <input type="text" id="test-api-key" placeholder="Enter test API key (e.g., sk-test123)">
        <br>
        <button onclick="saveTestApiKey()">Save API Key</button>
        <button onclick="loadTestApiKey()">Load API Key</button>
        <button onclick="clearTestApiKey()">Clear API Key</button>
        <div id="api-key-results"></div>
    </div>
    
    <div class="test-section">
        <h2>Settings Test</h2>
        <button onclick="testSettingsSave()">Test Save Settings</button>
        <button onclick="testSettingsLoad()">Test Load Settings</button>
        <button onclick="testSettingsReset()">Test Reset Settings</button>
        <div id="settings-results"></div>
    </div>
    
    <div class="test-section">
        <h2>Navigation Test</h2>
        <button onclick="testNavigation()">Test Settings Page Navigation</button>
        <div id="nav-results"></div>
    </div>
    
    <div class="test-section">
        <h2>Full Settings Page</h2>
        <button onclick="openSettingsPage()">Open Settings Page</button>
        <div id="full-page-results"></div>
    </div>
    
    <script src="./js/mock-api.js"></script>
    <script>
        // Helper function to display results
        function displayResult(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const result = document.createElement('div');
            result.className = `test-result ${type}`;
            result.innerHTML = `${new Date().toLocaleTimeString()}: ${message}`;
            container.appendChild(result);
        }
        
        // Environment check on load
        window.addEventListener('DOMContentLoaded', () => {
            checkEnvironment();
        });
        
        function checkEnvironment() {
            const envResults = document.getElementById('env-results');
            
            // Check browser/electron
            const isElectron = !!(window.api && window.api.invoke);
            displayResult('env-results', `Environment: ${isElectron ? 'Electron' : 'Browser'}`, 'info');
            
            // Check localStorage
            try {
                localStorage.setItem('test', 'value');
                localStorage.removeItem('test');
                displayResult('env-results', 'localStorage: Available ✓', 'success');
            } catch (error) {
                displayResult('env-results', `localStorage: Error - ${error.message}`, 'error');
            }
            
            // Check Mock API
            if (window.mockAPI) {
                displayResult('env-results', 'Mock API: Available ✓', 'success');
            } else {
                displayResult('env-results', 'Mock API: Not available', 'error');
            }
            
            // Check for existing saved data
            const savedKey = localStorage.getItem('novel-drive-openai-key');
            const savedSettings = localStorage.getItem('novel-drive-settings');
            
            displayResult('env-results', 
                `Saved API Key: ${savedKey ? 'Found ✓' : 'Not found'}`, 
                savedKey ? 'success' : 'info'
            );
            
            displayResult('env-results', 
                `Saved Settings: ${savedSettings ? 'Found ✓' : 'Not found'}`, 
                savedSettings ? 'success' : 'info'
            );
        }
        
        // API Key functions
        async function saveTestApiKey() {
            const apiKey = document.getElementById('test-api-key').value;
            if (!apiKey) {
                displayResult('api-key-results', 'Please enter an API key', 'error');
                return;
            }
            
            try {
                // Save to localStorage
                localStorage.setItem('novel-drive-openai-key', apiKey);
                displayResult('api-key-results', 'API key saved to localStorage ✓', 'success');
                
                // Also save via Mock API if available
                if (window.mockAPI) {
                    const result = await window.mockAPI.invoke('openai:setApiKey', { apiKey });
                    displayResult('api-key-results', 'API key saved via Mock API ✓', 'success');
                }
            } catch (error) {
                displayResult('api-key-results', `Error saving API key: ${error.message}`, 'error');
            }
        }
        
        function loadTestApiKey() {
            try {
                const savedKey = localStorage.getItem('novel-drive-openai-key');
                if (savedKey) {
                    document.getElementById('test-api-key').value = savedKey;
                    displayResult('api-key-results', `Loaded API key: ${savedKey.substring(0, 10)}...`, 'success');
                } else {
                    displayResult('api-key-results', 'No saved API key found', 'info');
                }
            } catch (error) {
                displayResult('api-key-results', `Error loading API key: ${error.message}`, 'error');
            }
        }
        
        function clearTestApiKey() {
            try {
                localStorage.removeItem('novel-drive-openai-key');
                document.getElementById('test-api-key').value = '';
                displayResult('api-key-results', 'API key cleared ✓', 'success');
            } catch (error) {
                displayResult('api-key-results', `Error clearing API key: ${error.message}`, 'error');
            }
        }
        
        // Settings functions
        async function testSettingsSave() {
            const testSettings = {
                api: {
                    openai: {
                        model: 'gpt-4',
                        temperature: 0.7
                    }
                },
                ai: {
                    writerModerateIgnorance: true,
                    responseLength: 'medium',
                    language: 'ja'
                },
                editor: {
                    fontSize: 16,
                    autoSave: true
                }
            };
            
            try {
                // Save to localStorage
                localStorage.setItem('novel-drive-settings', JSON.stringify(testSettings));
                displayResult('settings-results', 'Settings saved to localStorage ✓', 'success');
                displayResult('settings-results', `<pre>${JSON.stringify(testSettings, null, 2)}</pre>`, 'info');
                
                // Also save via Mock API if available
                if (window.mockAPI) {
                    const result = await window.mockAPI.invoke('settings:save', testSettings);
                    displayResult('settings-results', 'Settings saved via Mock API ✓', 'success');
                }
            } catch (error) {
                displayResult('settings-results', `Error saving settings: ${error.message}`, 'error');
            }
        }
        
        async function testSettingsLoad() {
            try {
                // Load from localStorage
                const savedSettings = localStorage.getItem('novel-drive-settings');
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);
                    displayResult('settings-results', 'Settings loaded from localStorage ✓', 'success');
                    displayResult('settings-results', `<pre>${JSON.stringify(settings, null, 2)}</pre>`, 'info');
                } else {
                    displayResult('settings-results', 'No saved settings in localStorage', 'info');
                }
                
                // Also load via Mock API if available
                if (window.mockAPI) {
                    const apiSettings = await window.mockAPI.invoke('settings:get');
                    displayResult('settings-results', 'Settings loaded via Mock API ✓', 'success');
                    displayResult('settings-results', `<pre>${JSON.stringify(apiSettings, null, 2)}</pre>`, 'info');
                }
            } catch (error) {
                displayResult('settings-results', `Error loading settings: ${error.message}`, 'error');
            }
        }
        
        function testSettingsReset() {
            try {
                localStorage.removeItem('novel-drive-settings');
                localStorage.removeItem('novel-drive-openai-key');
                localStorage.removeItem('novel-drive-openai-settings');
                displayResult('settings-results', 'All settings cleared from localStorage ✓', 'success');
            } catch (error) {
                displayResult('settings-results', `Error resetting settings: ${error.message}`, 'error');
            }
        }
        
        // Navigation test
        function testNavigation() {
            displayResult('nav-results', 'Testing navigation to settings page...', 'info');
            
            // Check if settings.html exists
            const settingsUrl = './settings.html';
            displayResult('nav-results', `Settings URL: ${settingsUrl}`, 'info');
            
            // Try to fetch the page
            fetch(settingsUrl)
                .then(response => {
                    if (response.ok) {
                        displayResult('nav-results', 'Settings page exists and is accessible ✓', 'success');
                    } else {
                        displayResult('nav-results', `Settings page returned status: ${response.status}`, 'error');
                    }
                })
                .catch(error => {
                    displayResult('nav-results', `Error accessing settings page: ${error.message}`, 'error');
                });
        }
        
        // Open settings page
        function openSettingsPage() {
            displayResult('full-page-results', 'Opening settings page in new window...', 'info');
            window.open('./settings.html', '_blank');
        }
    </script>
</body>
</html>