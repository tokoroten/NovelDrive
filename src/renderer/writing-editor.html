<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'">
    <title>執筆エディタ - NovelDrive</title>
    <link rel="stylesheet" href="./styles/common.css">
    <link rel="stylesheet" href="./styles/writing-editor.css">
    <link rel="stylesheet" href="./styles/ai-assistant.css">
    <link rel="stylesheet" href="./styles/ai-assistant-integrated.css">
    <link rel="stylesheet" href="./styles/ai-personality-criteria-link.css">
    <link rel="stylesheet" href="./styles/project-ai-settings.css">
    <link rel="stylesheet" href="./styles/ai-evaluation-panel.css">
    <link rel="stylesheet" href="./styles/writing-editor-fix.css">
</head>
<body>
    <div class="app-container">
        <!-- サイドバー -->
        <nav class="sidebar">
            <div class="app-title">
                <h1>NovelDrive</h1>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="./agent-meeting.html" data-page="agent-meeting">
                        <span class="icon">🤝</span>
                        <span>エージェント会議室</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="./projects.html" data-page="projects">
                        <span class="icon">📁</span>
                        <span>プロジェクト</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="./project-workspace.html" data-page="project-workspace">
                        <span class="icon">💼</span>
                        <span>ワークスペース</span>
                    </a>
                </li>
                <li class="nav-item active">
                    <a href="./writing-editor.html" data-page="writing-editor">
                        <span class="icon">✍️</span>
                        <span>執筆エディタ</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="./anything-box.html" data-page="anything-box">
                        <span class="icon">📥</span>
                        <span>なんでもボックス</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="./serendipity.html" data-page="serendipity">
                        <span class="icon">✨</span>
                        <span>セレンディピティ</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="./knowledge-graph.html" data-page="knowledge-graph">
                        <span class="icon">🕸️</span>
                        <span>ナレッジグラフ</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="./settings.html" data-page="settings">
                        <span class="icon">⚙️</span>
                        <span>設定</span>
                    </a>
                </li>
            </ul>
        </nav>

        <!-- メインコンテンツ -->
        <main class="main-content writing-layout">
            <!-- 左サイドパネル -->
            <aside class="left-panel">
                <div class="panel-header">
                    <h3>章構成</h3>
                    <select id="plot-selector" class="plot-selector">
                        <option value="">プロットを選択...</option>
                    </select>
                </div>
                
                <div class="chapters-nav">
                    <div id="chapters-list" class="chapters-list">
                        <!-- 章リストがここに表示される -->
                        <div class="empty-state">
                            <p>プロットを選択してください</p>
                        </div>
                    </div>
                </div>
                
                <div class="writing-stats">
                    <h4>執筆統計</h4>
                    <div class="stat-item">
                        <span class="stat-label">総文字数</span>
                        <span class="stat-value" id="total-chars">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">現在の章</span>
                        <span class="stat-value" id="current-chapter-chars">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">今日の執筆</span>
                        <span class="stat-value" id="today-chars">0</span>
                    </div>
                </div>
            </aside>

            <!-- エディタエリア -->
            <div class="editor-container">
                <div class="editor-header">
                    <div class="chapter-info">
                        <div class="chapter-navigation">
                            <button id="prev-chapter" class="chapter-nav-btn" title="前の章 (Ctrl+Left)" disabled>
                                <span class="icon">◀</span>
                            </button>
                            <div class="chapter-details">
                                <h2 id="chapter-title">章を選択してください</h2>
                                <div class="chapter-meta">
                                    <span id="chapter-number"></span>
                                    <span id="last-saved">未保存</span>
                                </div>
                            </div>
                            <button id="next-chapter" class="chapter-nav-btn" title="次の章 (Ctrl+Right)" disabled>
                                <span class="icon">▶</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="editor-toolbar">
                        <button id="save-content" class="toolbar-btn" title="保存 (Ctrl+S)">
                            <span class="icon">💾</span>
                        </button>
                        <button id="undo" class="toolbar-btn" title="元に戻す (Ctrl+Z)">
                            <span class="icon">↶</span>
                        </button>
                        <button id="redo" class="toolbar-btn" title="やり直す (Ctrl+Y)">
                            <span class="icon">↷</span>
                        </button>
                        <div class="toolbar-separator"></div>
                        <button id="search-btn" class="toolbar-btn" title="検索 (Ctrl+F)">
                            <span class="icon">🔍</span>
                        </button>
                        <button id="chapter-jump" class="toolbar-btn" title="章移動 (Ctrl+G)">
                            <span class="icon">📖</span>
                        </button>
                        <button id="goto-line" class="toolbar-btn" title="行移動 (Ctrl+Shift+G)">
                            <span class="icon">🔢</span>
                        </button>
                        <div class="toolbar-separator"></div>
                        <button id="version-history" class="toolbar-btn" title="バージョン履歴">
                            <span class="icon">📚</span>
                        </button>
                        <button id="auto-suggest-toggle" class="toolbar-btn active" title="自動提案を無効にする">
                            <span class="icon">🧠</span>
                        </button>
                        <div class="toolbar-separator"></div>
                        <button id="toggle-preview" class="toolbar-btn" title="プレビュー">
                            <span class="icon">👁️</span>
                        </button>
                        <button id="toggle-fullscreen" class="toolbar-btn" title="フルスクリーン">
                            <span class="icon">⛶</span>
                        </button>
                        <div class="toolbar-separator"></div>
                        <button id="ai-evaluate" class="toolbar-btn" title="AI評価">
                            <span class="icon">📊</span>
                            評価
                        </button>
                        <button id="link-criteria" class="toolbar-btn" title="評価基準設定">
                            <span class="icon">🔗</span>
                        </button>
                        <button id="project-ai-settings" class="toolbar-btn" title="プロジェクトAI設定">
                            <span class="icon">⚙️</span>
                        </button>
                    </div>
                </div>
                
                <div class="editor-content">
                    <div id="editor-wrapper" class="editor-wrapper">
                        <textarea 
                            id="editor" 
                            class="editor" 
                            placeholder="ここに執筆を始めてください..."
                            spellcheck="false"
                        ></textarea>
                    </div>
                    
                    <div id="preview-wrapper" class="preview-wrapper" style="display: none;">
                        <div id="preview" class="preview"></div>
                    </div>
                </div>
                
                <div class="editor-footer">
                    <div class="cursor-position">
                        <span id="line-number">1</span>:<span id="column-number">1</span>
                    </div>
                    <div class="word-count">
                        <span id="char-count">0</span>文字 | <span id="word-count">0</span>語
                    </div>
                </div>
            </div>

            <!-- 右サイドパネル -->
            <aside class="right-panel">
                <!-- タブ切り替え -->
                <div class="panel-tabs">
                    <button class="tab-btn active" data-tab="outline">アウトライン</button>
                    <button class="tab-btn" data-tab="knowledge">知識</button>
                    <button class="tab-btn" data-tab="notes">メモ</button>
                    <button class="tab-btn" data-tab="ai-assistant">AIアシスタント</button>
                </div>
                
                <!-- アウトラインタブ -->
                <div id="outline-tab" class="tab-content active">
                    <div class="outline-content">
                        <h4>章の概要</h4>
                        <div id="chapter-outline" class="chapter-outline">
                            <p class="empty-state">章が選択されていません</p>
                        </div>
                        
                        <h4>シーン</h4>
                        <div id="scenes-list" class="scenes-list">
                            <button class="add-scene-btn">+ シーンを追加</button>
                        </div>
                    </div>
                </div>
                
                <!-- 知識タブ -->
                <div id="knowledge-tab" class="tab-content">
                    <div class="knowledge-search">
                        <input type="text" id="knowledge-search" placeholder="知識を検索...">
                    </div>
                    <div id="knowledge-results" class="knowledge-results">
                        <!-- 検索結果がここに表示される -->
                    </div>
                </div>
                
                <!-- メモタブ -->
                <div id="notes-tab" class="tab-content">
                    <div class="notes-content">
                        <textarea 
                            id="chapter-notes" 
                            class="chapter-notes" 
                            placeholder="この章に関するメモを記入..."
                        ></textarea>
                    </div>
                </div>
                
                <!-- AIアシスタントタブ -->
                <div id="ai-assistant-tab" class="tab-content">
                    <div class="ai-assistant-content">
                        <!-- AIアシスタントのコンテンツがここに動的に生成されます -->
                    </div>
                </div>
            </aside>
        </main>
    </div>

    <!-- AI支援モーダル -->
    <div id="ai-assist-modal" class="modal" style="display: none;">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>AI執筆支援</h3>
                <button class="close-btn" onclick="closeAIAssistModal()">✕</button>
            </div>
            <div class="modal-body">
                <div class="ai-assist-options">
                    <button class="assist-option" data-action="continue">
                        <span class="option-icon">➡️</span>
                        <span class="option-title">続きを書く</span>
                        <span class="option-desc">選択したテキストの続きをAIが執筆</span>
                    </button>
                    <button class="assist-option" data-action="improve">
                        <span class="option-icon">✨</span>
                        <span class="option-title">文章を改善</span>
                        <span class="option-desc">選択部分をより良い表現に</span>
                    </button>
                    <button class="assist-option" data-action="expand">
                        <span class="option-icon">📝</span>
                        <span class="option-title">詳細を追加</span>
                        <span class="option-desc">描写や説明を豊かに</span>
                    </button>
                    <button class="assist-option" data-action="dialogue">
                        <span class="option-icon">💬</span>
                        <span class="option-title">対話を生成</span>
                        <span class="option-desc">キャラクター間の会話を作成</span>
                    </button>
                    <button class="assist-option" data-action="scene">
                        <span class="option-icon">🎬</span>
                        <span class="option-title">シーン描写</span>
                        <span class="option-desc">情景や雰囲気を詳しく描写</span>
                    </button>
                    <button class="assist-option" data-action="brainstorm">
                        <span class="option-icon">💡</span>
                        <span class="option-title">アイデア出し</span>
                        <span class="option-desc">展開のアイデアを提案</span>
                    </button>
                </div>
                
                <div class="ai-context">
                    <h4>コンテキスト</h4>
                    <div class="context-info">
                        <p>選択されたテキスト: <span id="selected-text-preview"></span></p>
                        <p>現在の章: <span id="context-chapter"></span></p>
                    </div>
                </div>
                
                <div id="ai-result" class="ai-result" style="display: none;">
                    <h4>AI提案</h4>
                    <div id="ai-suggestion" class="ai-suggestion"></div>
                    <div class="ai-actions">
                        <button class="primary-btn" onclick="acceptAISuggestion()">採用</button>
                        <button class="secondary-btn" onclick="regenerateAI()">再生成</button>
                        <button class="secondary-btn" onclick="rejectAISuggestion()">キャンセル</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- シーン編集モーダル -->
    <div id="scene-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>シーンを追加</h3>
                <button class="close-btn" onclick="closeSceneModal()">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="scene-title">シーンタイトル</label>
                    <input type="text" id="scene-title" placeholder="例: 主人公の登場">
                </div>
                <div class="form-group">
                    <label for="scene-location">場所</label>
                    <input type="text" id="scene-location" placeholder="例: 記憶のアーカイブ">
                </div>
                <div class="form-group">
                    <label for="scene-characters">登場人物</label>
                    <input type="text" id="scene-characters" placeholder="例: サラ、マーカス">
                </div>
                <div class="form-group">
                    <label for="scene-summary">概要</label>
                    <textarea id="scene-summary" rows="3" placeholder="このシーンで起こること"></textarea>
                </div>
            </div>
            <div class="modal-actions">
                <button class="primary-btn" onclick="saveScene()">保存</button>
                <button class="secondary-btn" onclick="closeSceneModal()">キャンセル</button>
            </div>
        </div>
    </div>

    <!-- 検索モーダル -->
    <div id="search-modal" class="search-modal" style="display: none;">
        <div class="search-modal-content">
            <div class="search-header">
                <div class="search-input-container">
                    <input type="text" id="search-input" class="search-input" placeholder="検索..." autocomplete="off">
                    <button id="search-prev" class="search-nav-btn" title="前を検索 (Shift+Enter)">↑</button>
                    <button id="search-next" class="search-nav-btn" title="次を検索 (Enter)">↓</button>
                    <button id="search-close" class="search-close-btn" title="閉じる (Esc)">✕</button>
                </div>
                <div class="search-options">
                    <label class="search-option">
                        <input type="checkbox" id="case-sensitive">
                        大文字小文字を区別
                    </label>
                    <label class="search-option">
                        <input type="checkbox" id="whole-word">
                        単語全体
                    </label>
                    <label class="search-option">
                        <input type="checkbox" id="regex-search">
                        正規表現
                    </label>
                </div>
            </div>
            <div class="search-replace-container" style="display: none;">
                <div class="replace-input-container">
                    <input type="text" id="replace-input" class="replace-input" placeholder="置換..." autocomplete="off">
                    <button id="replace-current" class="replace-btn">置換</button>
                    <button id="replace-all" class="replace-btn">すべて置換</button>
                </div>
            </div>
            <div class="search-info">
                <span id="search-count">0件の結果</span>
                <button id="toggle-replace" class="toggle-replace-btn">置換</button>
            </div>
        </div>
    </div>

    <!-- 章移動モーダル -->
    <div id="chapter-jump-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>章移動</h3>
                <button class="close-btn" onclick="closeChapterJumpModal()">✕</button>
            </div>
            <div class="modal-body">
                <div class="chapter-jump-list" id="chapter-jump-list">
                    <!-- 章リストがここに表示される -->
                </div>
            </div>
        </div>
    </div>

    <!-- 行移動モーダル -->
    <div id="goto-line-modal" class="modal" style="display: none;">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h3>行移動</h3>
                <button class="close-btn" onclick="closeGotoLineModal()">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="goto-line-input">移動先の行番号</label>
                    <input type="number" id="goto-line-input" min="1" placeholder="行番号を入力..." autocomplete="off">
                    <small class="help-text">現在の行: <span id="current-line-display">1</span> / 総行数: <span id="total-lines-display">1</span></small>
                </div>
            </div>
            <div class="modal-actions">
                <button class="primary-btn" onclick="performGotoLine()">移動</button>
                <button class="secondary-btn" onclick="closeGotoLineModal()">キャンセル</button>
            </div>
        </div>
    </div>


    <script src="./js/mock-api.js"></script>
    <script src="./js/project-selector.js"></script>
    <script src="./js/keyboard-shortcuts.js"></script>
    <script src="./js/undo-redo-manager.js"></script>
    <script src="./js/version-manager.js"></script>
    <script src="./js/version-compare-ui.js"></script>
    <script src="./js/knowledge-suggest.js"></script>
    <script src="./js/search-manager.js"></script>
    <script src="./js/ai-thread-manager.js"></script>
    <script src="./js/ai-writing-assistant.js"></script>
    <script src="./js/ai-personality-canvas.js"></script>
    <script src="./js/evaluation-criteria-canvas.js"></script>
    <script src="./js/ai-personality-criteria-link.js"></script>
    <script src="./js/project-ai-settings.js"></script>
    <script src="./js/ai-evaluation-panel.js"></script>
    <script src="./js/writing-editor.js"></script>
</body>
</html>