# NovelDrive 機能仕様書

## 1. システム概要

NovelDriveは、知識ネットワーク型の創造的執筆プラットフォームです。人間の「うっすらとした記憶」や創発的な発想プロセスを模倣し、マルチエージェントAIシステムによる対話的な創作支援を提供します。

### システムアーキテクチャ（二層構造）

#### 第1層：創造的知識管理システム
- **セレンディピティ付きナレッジベース**（Obsidian/Scrapboxライク）
- なんでもボックスによる情報収集
- 自動的なノード生成と関連付け
- AIによるインスピレーション抽出
- 時間経過による情報の発酵・熟成
- 創作結果のフィードバック受け入れ

#### 第2層：小説創作エンジン
- **マルチエージェントシステム**
- 第1層の知識を活用した創作
- プロット生成・議論・執筆・校閲の自動化
- 人間との対話的な創作プロセス
- 作家AIは常にセレンディピティ検索を実行

### 層間の連携

#### データアクセス
- 第2層から第1層へ：セレンディピティ検索による自由なアクセス
- 検索の度に予期せぬ組み合わせを発見
- アイデアの多様性を維持

#### ナレッジ管理の階層
- **グローバルナレッジ**：全作品共通の知識プール
- **作品ナレッジ**：特定作品の世界設定、キャラクター表など
- **プロジェクト切り替え**：作品単位で独立した管理が可能

#### UI/UXの統合
- 知識管理モードと創作モードのシームレスな切り替え
- 分割ビューで両モードを同時表示可能
- ショートカットキーでの高速切り替え

## 2. コア機能

### 2.1 ユニバーサルノードシステム

#### ノードの種類
- **テキストノード**: アイデア、セリフ、描写、メモ
- **画像ノード**: AI生成画像（DALL-E）、参考画像、イメージボード
- **キャラクターノード**: 人物設定、相関関係、成長記録
- **世界観ノード**: 場所、ルール、歴史、文化設定
- **音声/音楽ノード**: BGM、効果音、音声メモ
- **プロットノード**: ストーリー構成、章立て、シーン
- **リンクノード**: URL、参考資料、取材メモ

#### 自動リンク生成
- 本文中の固有名詞（人名・地名）を自動認識してリンク化
- 関係性キーワード（「兄」「恋人」「師匠」等）から相関図を自動構築
- 同一場所・時間軸のシーンを自動グルーピング
- ベクトル類似度による意味的な関連付け

### 2.2 AI画像生成統合

#### 画像生成機能
- キャラクター設定からの立ち絵自動生成
- シーン描写からの場面イメージ生成
- 任意のノードからワンクリックで画像化
- 生成プロンプトの保存とベクトル化（検索可能）

#### プロンプト管理
- プロンプトテンプレート（画風、構図、雰囲気）
- プロンプト編集・改良履歴
- プロンプトから逆引きでの文章アイデア生成

### 2.3 プロット管理システム

#### バージョニング機能
1. プロットAをマルチエージェントで議論・構築
2. ある程度まとまったら人間が複製してプロットA'を作成
3. A'を改変対象として議論継続
4. 分岐したプロットの比較・マージ機能
5. プロット進化の履歴を保持

#### プロット構造
- 三幕構成、起承転結、ヒーローズジャーニー等のテンプレート
- ビートシート形式での詳細管理
- 各シーンの重要度・感情曲線の可視化

### 2.4 マルチエージェントシステム

#### エージェントの役割と性格
- **作家AI**: 創造的、「もしも〜だったら」の発想、アイデア拡張
- **編集AI**: 構成重視、読者視点、ペース配分の提案
- **ツッコミAI**: 矛盾検出、整合性チェック、リアリティ確認
- **副編集長AI**: 市場性、ジャンル慣習、商業的視点

#### 対話システム
- リアルタイムでの自律的対話
- ユーザーによる任意タイミングでの割り込み
- 停止/再開ボタン
- 議論ログの保存と検索

### 2.5 なんでもボックス（万能インプットシステム）

#### 基本機能
- ニュース記事、SNS投稿、論文、日記など、あらゆるテキストを投入可能
- コピペ、ドラッグ&ドロップ、URL入力で簡単取り込み
- 画像（OCR自動実行）、音声（自動文字起こし）にも対応

#### インスピレーション抽出システム
- **元文章の保存**: 原文をそのまま保存（著作権情報も記録）
- **自動分析**:
  - キーワード抽出
  - 感情分析
  - 構造分析（5W1H）
  - ジャンル推定
- **インスピレーション生成**:
  - 「もしもこれが小説だったら」変換
  - 登場人物の抽出・創造
  - シチュエーションの小説化
  - 世界観への組み込み提案
- **メタデータ付与**:
  - 取り込み日時
  - ソース情報
  - AIが見出した創作可能性スコア

#### 消化プロセス
1. **即座の分解**: 投入された文章を要素に分解
2. **発酵**: 時間経過で他の要素と化学反応
3. **結晶化**: 小説のアイデアとして具体化
4. **ネットワーク接続**: 既存のノードと自動リンク

#### Webクローラー機能
- **URLからの自動収集**: 指定URLから同一ドメイン内をn段階クロール
- **深さ制限**: クロール深度を1〜5段階で設定可能
- **AIによるコンテンツ抽出**: 
  - 取得したHTMLをLLMに送信
  - メインコンテンツ部分を自動識別・抽出
  - ヘッダー、フッター、広告、ナビゲーションを除外
  - 本文、タイトル、メタデータを構造化して保存
- **重複排除**: 同一URLは再クロールしない
- **インクリメンタル更新**: 新規・更新されたコンテンツのみ取得
- **ドメイン制限**: 同一ドメイン内のみクロール（セキュリティ対策）
- **レート制限**: サーバー負荷を考慮した適切な間隔でアクセス（1秒以上）
- **一括インポート**: クロールした全ページを自動的にナレッジ化
- **リンク構造保持**: ページ間のリンク関係もナレッジグラフに反映

### 2.6 創発的アイデア生成

#### 自動生成されるアイデアの種類
- **シーン提案**: 既存要素の組み合わせから新シーンを創出
- **ギミック提案**: 世界観に合った仕掛けやルールの提案
- **キャラ掘り下げ**: 背景ストーリー、隠された一面の提案
- **世界観拡張**: 設定の論理的拡張と詳細化

#### アイデア提示インターフェース
- カード形式での提示（スワイプで採用/却下）
- 採用理由・却下理由の記録
- AIによる推薦理由の表示
- 評価軸（新規性、実現可能性、物語への影響度）の可視化
- 採用したアイデアはナレッジストレージに自動保存

#### 創発アルゴリズム
- ランダムな2-3要素の組み合わせ
- 意味的距離が遠い要素の強制接続
- 時間経過による「熟成」効果
- コンテキストに応じた関連度調整
- なんでもボックスから消化された要素も組み合わせ対象

#### アイデアストレージ管理
- 採用したアイデアの自動分類（シーン、キャラ、世界観等）
- 採用履歴とコンテキストの記録
- 既存ノードとの自動リンク生成
- 重要度/優先度の設定

## 3. データ管理

### 3.1 ストレージ構造
- DuckDB: 構造化データ、全文検索、メタデータ
- ベクトルDB: 意味的類似検索
- ファイルシステム: 画像、音声ファイル
- JSON: 柔軟なスキーマデータ

### 3.2 検索システム
- 日本語全文検索（TinySegmenter統合）
- ベクトル類似検索
- メタデータフィルタリング（時期、タグ、カテゴリ）
- ハイブリッド検索とリランキング

#### ハイブリッド検索の実装
参考: https://voluntas.ghost.io/duckdb-hybrid-search/

1. **全文検索（FTS）**: BM25スコアリングで関連文書を取得
2. **ベクトル検索（VSS）**: コサイン類似度で意味的に近い文書を取得
3. **リランキング**: 両方の結果をマージして再評価

#### リランキングアルゴリズム
```sql
-- 全文検索結果とベクトル検索結果を統合
WITH fts_results AS (
  SELECT id, content, bm25_score 
  FROM nodes_fts 
  WHERE nodes_fts MATCH ?
),
vss_results AS (
  SELECT id, content, 
    1 - array_cosine_distance(embeddings, ?::FLOAT[1024]) as similarity_score
  FROM nodes
  ORDER BY embeddings <=> ?::FLOAT[1024]
  LIMIT 50
),
-- 結果をマージしてスコアを正規化
merged_results AS (
  SELECT 
    COALESCE(f.id, v.id) as id,
    COALESCE(f.content, v.content) as content,
    COALESCE(f.bm25_score, 0) as fts_score,
    COALESCE(v.similarity_score, 0) as vss_score,
    -- ハイブリッドスコア計算
    (0.3 * COALESCE(f.bm25_score, 0) + 
     0.7 * COALESCE(v.similarity_score, 0)) as hybrid_score
  FROM fts_results f
  FULL OUTER JOIN vss_results v ON f.id = v.id
)
SELECT * FROM merged_results
ORDER BY hybrid_score DESC
LIMIT 20;
```

## 4. UI/UX設計

### 4.1 画面構成
- **ダッシュボード**: プロジェクト一覧、最近の活動
- **ノードエクスプローラー**: グラフビュー、リスト表示切替
- **エディター**: 執筆画面、リアルタイムAI提案
- **エージェント会議室**: AI対話の可視化
- **プロット管理**: バージョン比較、タイムライン表示

### 4.2 インタラクション
- ドラッグ&ドロップでのノード接続
- ダブルクリックでのクイック編集
- ショートカットキーでのAI呼び出し
- リアルタイムプレビュー

## 5. 追加機能

### 5.1 分析・可視化
- **感情グラフ**: 章ごとのキャラクター感情推移
- **伏線トラッカー**: 配置と回収の時系列管理
- **読者視点シミュレータ**: 初見読者の情報制限モード
- **自動年表生成**: 作中イベントの時系列整理

### 5.2 エクスポート・共有
- 縦書きPDF出力（ルビ対応）
- EPUB生成
- Web小説サイト形式への変換
- プロット共有URL生成

## 6. 技術仕様

### 6.1 API統合
- OpenAI API（GPT-4、DALL-E）
- Thread機能の活用
- API設定の一元管理

### 6.2 パフォーマンス
- Web Worker での重い処理
- インクリメンタル検索
- 遅延読み込み
- キャッシュ戦略

## 7. 将来的な拡張

- 音声入力・読み上げ機能
- VRでの空間的プロット構築
- 共同執筆・リアルタイムコラボレーション
- モバイルアプリ版